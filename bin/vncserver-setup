#!/bin/bash

set -euo pipefail
IFS=

# Depend on mod-user having been run (TODO: cope without?).

set -x

cd

if [ ! -x .vnc/xstartup ]; then
    private mkdir -p .vnc
    cat > .vnc/xstartup <<'EOF'
#!/bin/sh
[ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
[ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
xsetroot -solid grey
vncconfig -iconic &
xfce4-session
EOF
    chmod +x .vnc/xstartup
fi

/opt/chj/chjize/bin/vncserver-daemon start

tmp=$(tempfile)

{
printf 'PATH=%q\n' "$PATH"
crontab -l
printf '\n@reboot /opt/chj/chjize/bin/vncserver-daemon start\n'
} > "$tmp"

crontab "$tmp"

set +x

cat <<EOF
Done.

An entry to start the vncserver-daemon has been added to the
crontab. Remove it again if that's not what you wanted (maybe along
with the PATH env var setting at the top).

EOF
